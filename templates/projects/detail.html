{% extends "base.html" %}
{% block title %}{{ project.name }} - Taskmaster{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-start mb-3">
    <div>
        <h1>{{ project.name }}</h1>
        {% if project.description %}
        <p class="text-muted">{{ project.description }}</p>
        {% endif %}
        <div class="mb-2">
            <span class="badge badge-{{ project.status }}">{{ project.status | replace('_', ' ') | title }}</span>
            {% if project.start_date %}<span class="text-muted ms-2">{{ project.start_date }}</span>{% endif %}
            {% if project.end_date %}<span class="text-muted"> &mdash; {{ project.end_date }}</span>{% endif %}
        </div>
    </div>
    <div>
        <a href="{{ url_for('tasks.new_task', project_id=project.id) }}" class="btn btn-primary btn-sm">Add Task</a>
        <a href="{{ url_for('projects.edit_project', id=project.id) }}" class="btn btn-outline-secondary btn-sm">Edit</a>
        <form method="post" action="{{ url_for('projects.delete_project', id=project.id) }}" class="d-inline"
              onsubmit="return confirm('Delete this project and all its tasks?')">
            <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
        </form>
    </div>
</div>

{% if project.tasks %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Gantt Chart</h5>
    </div>
    <div class="card-body gantt-container">
        <svg id="gantt"></svg>
    </div>
</div>

<div class="card">
    <div class="card-header"><h5 class="mb-0">Tasks</h5></div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Assignee</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Dates</th>
                        <th>Tags</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in project.tasks %}
                    <tr>
                        <td><a href="{{ url_for('tasks.detail', id=task.id) }}">{{ task.title }}</a></td>
                        <td>
                            {% if task.assignee %}
                            <a href="{{ url_for('people.detail', id=task.assignee.id) }}">{{ task.assignee.name }}</a>
                            {% else %}
                            <span class="text-muted">Unassigned</span>
                            {% endif %}
                        </td>
                        <td><span class="badge badge-{{ task.status }}">{{ task.status | replace('_', ' ') | title }}</span></td>
                        <td><span class="badge badge-{{ task.priority }}">{{ task.priority | title }}</span></td>
                        <td class="small">{{ task.start_date }} &mdash; {{ task.end_date }}</td>
                        <td>
                            {% for tag in task.tags %}
                            <span class="badge bg-secondary">{{ tag.name }}</span>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
<div class="text-center py-5">
    <p class="text-muted">No tasks yet.</p>
    <a href="{{ url_for('tasks.new_task', project_id=project.id) }}" class="btn btn-primary">Add the first task</a>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if project.tasks %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    fetch('{{ url_for("projects.gantt_data", id=project.id) }}')
        .then(r => r.json())
        .then(tasks => {
            if (tasks.length === 0) return;
            var gantt = new Gantt("#gantt", tasks, {
                view_mode: 'Week',
                date_format: 'YYYY-MM-DD',
                custom_popup_html: function(task) {
                    return `<div class="p-2">
                        <strong>${task.name}</strong><br>
                        <small>${task.start} to ${task.end}</small><br>
                        <small>Progress: ${task.progress}%</small>
                    </div>`;
                },
                on_click: function(task) {
                    var taskId = task.id.replace('task-', '');
                    window.location.href = '/tasks/' + taskId;
                }
            });
        });
});
</script>
{% endif %}
{% endblock %}
