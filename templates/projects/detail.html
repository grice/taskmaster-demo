{% extends "base.html" %}
{% block title %}{{ project.name }} - Taskmaster{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-start mb-3">
    <div>
        <h1>{{ project.name }}</h1>
        {% if project.description %}
        <p class="text-muted">{{ project.description }}</p>
        {% endif %}
        <div class="mb-2">
            <span class="badge badge-{{ project.status }}">{{ project.status | replace('_', ' ') | title }}</span>
            {% if project.start_date %}<span class="text-muted ms-2">{{ project.start_date }}</span>{% endif %}
            {% if project.end_date %}<span class="text-muted"> &mdash; {{ project.end_date }}</span>{% endif %}
        </div>
    </div>
    <div>
        <a href="{{ url_for('tasks.new_task', project_id=project.id) }}" class="btn btn-primary btn-sm">Add Task</a>
        <a href="{{ url_for('projects.edit_project', id=project.id) }}" class="btn btn-outline-secondary btn-sm">Edit</a>
        <form method="post" action="{{ url_for('projects.delete_project', id=project.id) }}" class="d-inline"
              onsubmit="return confirm('Delete this project and all its tasks?')">
            <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
        </form>
    </div>
</div>

<div class="row g-4">
<div class="col-lg-8">
    {% if project.tasks %}
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Gantt Chart</h5>
            <div class="btn-group btn-group-sm" id="gantt-zoom">
                <button type="button" class="btn btn-outline-secondary" data-mode="Day">Day</button>
                <button type="button" class="btn btn-outline-secondary active" data-mode="Week">Week</button>
                <button type="button" class="btn btn-outline-secondary" data-mode="Month">Month</button>
                <button type="button" class="btn btn-outline-secondary" data-mode="Year">Year</button>
            </div>
        </div>
        <div class="card-body gantt-container">
            <svg id="gantt"></svg>
        </div>
    </div>

    {% if upcoming_milestones %}
    <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0">Upcoming Milestones</h5></div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Milestone</th>
                            <th>Task</th>
                            <th>Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ms in upcoming_milestones %}
                        <tr>
                            <td class="milestone-diamond">&#9670;</td>
                            <td>{{ ms.name }}</td>
                            <td><a href="{{ url_for('tasks.detail', id=ms.task.id) }}">{{ ms.task.title }}</a></td>
                            <td class="small">{{ ms.date }}</td>
                            <td><span class="badge milestone-{{ ms.computed_status }}">{{ ms.computed_status | replace('_', ' ') | title }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header"><h5 class="mb-0">Tasks</h5></div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Assigned</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Dates</th>
                            <th>Tags</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in project.tasks %}
                        <tr>
                            <td><a href="{{ url_for('tasks.detail', id=task.id) }}">{{ task.title }}</a></td>
                            <td>
                                {% if task.assignees %}
                                    {% for person in task.assignees %}
                                    <a href="{{ url_for('people.detail', id=person.id) }}">{{ person.name }}</a>{% if task.lead and person.id == task.lead.id %} <span class="badge bg-info text-dark" style="font-size:0.65em">lead</span>{% endif %}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                {% else %}
                                <span class="text-muted">Unassigned</span>
                                {% endif %}
                            </td>
                            <td><span class="badge badge-{{ task.status }}">{{ task.status | replace('_', ' ') | title }}</span></td>
                            <td><span class="badge badge-{{ task.priority }}">{{ task.priority | title }}</span></td>
                            <td class="small">{{ task.start_date }} &mdash; {{ task.end_date }}</td>
                            <td>
                                {% for tag in task.tags %}
                                <span class="badge bg-secondary">{{ tag.name }}</span>
                                {% endfor %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-5">
        <p class="text-muted">No tasks yet.</p>
        <a href="{{ url_for('tasks.new_task', project_id=project.id) }}" class="btn btn-primary">Add the first task</a>
    </div>
    {% endif %}
</div>

<div class="col-lg-4">
    <div class="card" style="position: sticky; top: 1rem;">
        <div class="card-header"><h5 class="mb-0">Project Updates</h5></div>
        <div class="card-body" style="max-height: 80vh; overflow-y: auto;">
            {% if all_updates %}
            <div class="status-timeline">
                {% for update in all_updates %}
                <div class="update-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <a href="{{ url_for('tasks.detail', id=update.task.id) }}" class="fw-semibold small text-decoration-none">{{ update.task.title }}</a>
                        <span class="badge badge-{{ update.task.status }}" style="font-size:0.65em">{{ update.task.status | replace('_', ' ') | title }}</span>
                    </div>
                    <div class="text-muted small">{{ update.created_at.strftime('%b %d, %Y at %I:%M %p') }}</div>
                    <div class="small">{{ update.content|render_mentions }}</div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted mb-0 small">No updates yet. Add status updates from individual task pages.</p>
            {% endif %}
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block scripts %}
{% if project.tasks %}
<!-- Hover tooltip for Gantt bars -->
<div id="gantt-tooltip" class="card shadow-sm" style="display:none; position:fixed; z-index:1060; width:360px; pointer-events:none;">
    <div class="card-body py-2 px-3">
        <strong id="tooltip-title"></strong>
        <div class="small text-muted mt-1" id="tooltip-dates"></div>
        <div class="small mt-1" id="tooltip-progress"></div>
        <div class="small mt-1"><strong id="tooltip-extra-label">Assigned:</strong> <span id="tooltip-assignees"></span></div>
    </div>
</div>

<!-- Inline edit popup for Gantt bars -->
<div id="gantt-popup" class="card shadow" style="display:none; position:fixed; z-index:1050; width:300px;">
    <div class="card-header d-flex justify-content-between align-items-center py-2">
        <strong id="popup-title"></strong>
        <button type="button" class="btn-close btn-close-sm" id="popup-close"></button>
    </div>
    <div class="card-body py-2">
        <form id="popup-form">
            <div class="mb-2">
                <label class="form-label small mb-0">Start Date</label>
                <input type="date" class="form-control form-control-sm" id="popup-start">
            </div>
            <div class="mb-2">
                <label class="form-label small mb-0">End Date</label>
                <input type="date" class="form-control form-control-sm" id="popup-end">
            </div>
            <div class="mb-2">
                <label class="form-label small mb-0">Status</label>
                <select class="form-select form-select-sm" id="popup-status">
                    <option value="todo">Todo</option>
                    <option value="in_progress">In Progress</option>
                    <option value="done">Done</option>
                </select>
            </div>
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-sm flex-grow-1">Save</button>
                <a id="popup-detail-link" href="#" class="btn btn-outline-secondary btn-sm">Full Edit</a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var popup = document.getElementById('gantt-popup');
    var tooltip = document.getElementById('gantt-tooltip');
    var currentTaskId = null;

    function hidePopup() {
        popup.style.display = 'none';
        currentTaskId = null;
    }

    document.getElementById('popup-close').addEventListener('click', hidePopup);

    // Close popup when clicking outside
    document.addEventListener('click', function(e) {
        if (popup.style.display !== 'none' && !popup.contains(e.target) && !e.target.closest('.bar-wrapper')) {
            hidePopup();
        }
    });

    document.getElementById('popup-form').addEventListener('submit', function(e) {
        e.preventDefault();
        if (!currentTaskId) return;

        var numericId = currentTaskId.replace('task-', '');
        fetch('/tasks/' + numericId + '/quick-update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                start_date: document.getElementById('popup-start').value,
                end_date: document.getElementById('popup-end').value,
                status: document.getElementById('popup-status').value,
            })
        })
        .then(r => r.json())
        .then(function() {
            hidePopup();
            location.reload();
        });
    });

    fetch('{{ url_for("projects.gantt_data", id=project.id) }}')
        .then(r => r.json())
        .then(tasks => {
            if (tasks.length === 0) return;

            // Build a lookup from task id to its data
            var taskMap = {};
            tasks.forEach(function(t) { taskMap[t.id] = t; });

            var gantt = new Gantt("#gantt", tasks, {
                view_mode: 'Week',
                date_format: 'YYYY-MM-DD',
                custom_popup_html: function() { return ''; },
                on_date_change: function(task, start, end) {
                    var numericId = task.id.replace('task-', '');
                    var startStr = start.toISOString().slice(0, 10);
                    var endStr = end.toISOString().slice(0, 10);
                    // Update local lookup
                    if (taskMap[task.id]) {
                        taskMap[task.id].start = startStr;
                        taskMap[task.id].end = endStr;
                    }
                    fetch('/tasks/' + numericId + '/quick-update', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ start_date: startStr, end_date: endStr })
                    });
                },
                on_progress_change: function(task, progress) {
                    var numericId = task.id.replace('task-', '');
                    // Map progress to status
                    var status = 'todo';
                    if (progress >= 100) status = 'done';
                    else if (progress > 0) status = 'in_progress';
                    if (taskMap[task.id]) {
                        var cls = taskMap[task.id].custom_class.replace(/status-\w+/, 'status-' + status);
                        taskMap[task.id].custom_class = cls;
                    }
                    fetch('/tasks/' + numericId + '/quick-update', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ status: status })
                    });
                },
            });

            // Single-click listener on bar elements (Frappe Gantt binds on_click to dblclick)
            function showPopup(taskId, e) {
                var data = taskMap[taskId];
                if (!data) return;
                tooltip.style.display = 'none';
                currentTaskId = taskId;
                var numericId = taskId.replace('task-', '');

                document.getElementById('popup-title').textContent = data.name;
                document.getElementById('popup-start').value = data.start;
                document.getElementById('popup-end').value = data.end;
                document.getElementById('popup-detail-link').href = '/tasks/' + numericId;

                var statusMatch = data.custom_class.match(/status-(\w+)/);
                if (statusMatch) {
                    document.getElementById('popup-status').value = statusMatch[1];
                }

                var bar = e.target.closest('.bar-wrapper');
                if (bar) {
                    var rect = bar.getBoundingClientRect();
                    popup.style.top = (rect.bottom + 8) + 'px';
                    popup.style.left = Math.min(rect.left, window.innerWidth - 320) + 'px';
                } else {
                    popup.style.top = (e.clientY + 10) + 'px';
                    popup.style.left = Math.min(e.clientX, window.innerWidth - 320) + 'px';
                }
                popup.style.display = 'block';
            }

            function bindBars() {
                document.querySelectorAll('.bar-wrapper').forEach(function(bar) {
                    bar.addEventListener('click', function(e) {
                        // Ignore clicks on milestone diamonds
                        if (e.target.closest('.gantt-milestone')) return;
                        var taskId = bar.getAttribute('data-id');
                        if (taskId) showPopup(taskId, e);
                    });

                    bar.addEventListener('mouseenter', function(e) {
                        var taskId = bar.getAttribute('data-id');
                        var data = taskMap[taskId];
                        if (!data) return;
                        if (popup.style.display !== 'none') return;

                        document.getElementById('tooltip-title').textContent = data.name;
                        document.getElementById('tooltip-dates').textContent = data.start + ' to ' + data.end;
                        document.getElementById('tooltip-progress').textContent = 'Progress: ' + data.progress + '%';
                        document.getElementById('tooltip-extra-label').textContent = 'Assigned:';
                        document.getElementById('tooltip-assignees').textContent = data.assignees;

                        var rect = bar.getBoundingClientRect();
                        tooltip.style.top = (rect.bottom + 8) + 'px';
                        tooltip.style.left = Math.min(rect.left, window.innerWidth - 380) + 'px';
                        tooltip.style.display = 'block';
                    });

                    bar.addEventListener('mouseleave', function() {
                        tooltip.style.display = 'none';
                    });
                });

            }

            function renderMilestones() {
                // Remove any existing milestone overlay group
                var existing = document.querySelector('.milestone-overlay');
                if (existing) existing.remove();

                var svg = document.querySelector('#gantt');
                if (!svg) return;

                // Create a separate group on top of everything (outside bar-wrappers)
                var overlay = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                overlay.setAttribute('class', 'milestone-overlay');
                svg.appendChild(overlay);

                document.querySelectorAll('.bar-wrapper').forEach(function(bar) {
                    var taskId = bar.getAttribute('data-id');
                    var data = taskMap[taskId];
                    if (!data || !data.milestones || data.milestones.length === 0) return;
                    var rect = bar.querySelector('.bar');
                    if (!rect) return;
                    var barX = parseFloat(rect.getAttribute('x'));
                    var barW = parseFloat(rect.getAttribute('width'));
                    var barY = parseFloat(rect.getAttribute('y'));
                    var barH = parseFloat(rect.getAttribute('height'));
                    var startMs = new Date(data.start).getTime();
                    var endMs = new Date(data.end).getTime();
                    var range = endMs - startMs;
                    if (range <= 0) return;
                    data.milestones.forEach(function(ms) {
                        var msMs = new Date(ms.date).getTime();
                        var frac = (msMs - startMs) / range;
                        var cx = barX + frac * barW;
                        var cy = barY - 2;
                        var size = 7;
                        var color = ms.status === 'delayed' ? '#dc3545' : ms.status === 'on_hold' ? '#fd7e14' : '#198754';
                        var diamond = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                        var points = [
                            (cx) + ',' + (cy - size),
                            (cx + size) + ',' + (cy),
                            (cx) + ',' + (cy + size),
                            (cx - size) + ',' + (cy)
                        ].join(' ');
                        diamond.setAttribute('points', points);
                        diamond.setAttribute('fill', color);
                        diamond.setAttribute('stroke', '#fff');
                        diamond.setAttribute('stroke-width', '1.5');
                        diamond.setAttribute('class', 'gantt-milestone');
                        diamond.style.cursor = 'default';

                        // Milestone hover: show milestone info instead of task info
                        diamond.addEventListener('mouseenter', function(e) {
                            if (popup.style.display !== 'none') return;
                            document.getElementById('tooltip-title').textContent = ms.name;
                            document.getElementById('tooltip-dates').textContent = 'Date: ' + ms.date;
                            document.getElementById('tooltip-progress').textContent = 'Status: ' + ms.status.replace('_', ' ');
                            document.getElementById('tooltip-extra-label').textContent = 'Task:';
                            document.getElementById('tooltip-assignees').textContent = data.name;
                            var bRect = diamond.getBoundingClientRect();
                            tooltip.style.top = (bRect.bottom + 8) + 'px';
                            tooltip.style.left = Math.min(bRect.left - 160, window.innerWidth - 380) + 'px';
                            tooltip.style.display = 'block';
                        });
                        diamond.addEventListener('mouseleave', function() {
                            tooltip.style.display = 'none';
                        });

                        overlay.appendChild(diamond);
                    });
                });
            }

            bindBars();
            renderMilestones();

            // Zoom buttons
            document.querySelectorAll('#gantt-zoom button').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    document.querySelector('#gantt-zoom .active').classList.remove('active');
                    btn.classList.add('active');
                    hidePopup();
                    tooltip.style.display = 'none';
                    gantt.change_view_mode(btn.getAttribute('data-mode'));
                    setTimeout(function() { bindBars(); renderMilestones(); }, 100);
                });
            });
        });
});
</script>
{% endif %}
{% endblock %}
