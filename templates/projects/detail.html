{% extends "base.html" %}
{% block title %}{{ project.name }} - Taskmaster{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-start mb-3">
    <div>
        <h1>{{ project.name }}</h1>
        {% if project.description %}
        <p class="text-muted">{{ project.description }}</p>
        {% endif %}
        <div class="mb-2">
            <span class="badge badge-{{ project.status }}">{{ project.status | replace('_', ' ') | title }}</span>
            {% if project.start_date %}<span class="text-muted ms-2">{{ project.start_date }}</span>{% endif %}
            {% if project.end_date %}<span class="text-muted"> &mdash; {{ project.end_date }}</span>{% endif %}
        </div>
    </div>
    <div>
        <a href="{{ url_for('tasks.new_task', project_id=project.id) }}" class="btn btn-primary btn-sm">Add Task</a>
        <a href="{{ url_for('projects.edit_project', id=project.id) }}" class="btn btn-outline-secondary btn-sm">Edit</a>
        <form method="post" action="{{ url_for('projects.delete_project', id=project.id) }}" class="d-inline"
              onsubmit="return confirm('Delete this project and all its tasks?')">
            <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
        </form>
    </div>
</div>

{% if project.tasks %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Gantt Chart</h5>
    </div>
    <div class="card-body gantt-container">
        <svg id="gantt"></svg>
    </div>
</div>

<div class="card">
    <div class="card-header"><h5 class="mb-0">Tasks</h5></div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Assignee</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Dates</th>
                        <th>Tags</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in project.tasks %}
                    <tr>
                        <td><a href="{{ url_for('tasks.detail', id=task.id) }}">{{ task.title }}</a></td>
                        <td>
                            {% if task.assignee %}
                            <a href="{{ url_for('people.detail', id=task.assignee.id) }}">{{ task.assignee.name }}</a>
                            {% else %}
                            <span class="text-muted">Unassigned</span>
                            {% endif %}
                        </td>
                        <td><span class="badge badge-{{ task.status }}">{{ task.status | replace('_', ' ') | title }}</span></td>
                        <td><span class="badge badge-{{ task.priority }}">{{ task.priority | title }}</span></td>
                        <td class="small">{{ task.start_date }} &mdash; {{ task.end_date }}</td>
                        <td>
                            {% for tag in task.tags %}
                            <span class="badge bg-secondary">{{ tag.name }}</span>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
<div class="text-center py-5">
    <p class="text-muted">No tasks yet.</p>
    <a href="{{ url_for('tasks.new_task', project_id=project.id) }}" class="btn btn-primary">Add the first task</a>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if project.tasks %}
<!-- Inline edit popup for Gantt bars -->
<div id="gantt-popup" class="card shadow" style="display:none; position:fixed; z-index:1050; width:300px;">
    <div class="card-header d-flex justify-content-between align-items-center py-2">
        <strong id="popup-title"></strong>
        <button type="button" class="btn-close btn-close-sm" id="popup-close"></button>
    </div>
    <div class="card-body py-2">
        <form id="popup-form">
            <div class="mb-2">
                <label class="form-label small mb-0">Start Date</label>
                <input type="date" class="form-control form-control-sm" id="popup-start">
            </div>
            <div class="mb-2">
                <label class="form-label small mb-0">End Date</label>
                <input type="date" class="form-control form-control-sm" id="popup-end">
            </div>
            <div class="mb-2">
                <label class="form-label small mb-0">Status</label>
                <select class="form-select form-select-sm" id="popup-status">
                    <option value="todo">Todo</option>
                    <option value="in_progress">In Progress</option>
                    <option value="done">Done</option>
                </select>
            </div>
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-sm flex-grow-1">Save</button>
                <a id="popup-detail-link" href="#" class="btn btn-outline-secondary btn-sm">Full Edit</a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var popup = document.getElementById('gantt-popup');
    var currentTaskId = null;

    function hidePopup() {
        popup.style.display = 'none';
        currentTaskId = null;
    }

    document.getElementById('popup-close').addEventListener('click', hidePopup);

    // Close popup when clicking outside
    document.addEventListener('click', function(e) {
        if (popup.style.display !== 'none' && !popup.contains(e.target) && !e.target.closest('.bar-wrapper')) {
            hidePopup();
        }
    });

    document.getElementById('popup-form').addEventListener('submit', function(e) {
        e.preventDefault();
        if (!currentTaskId) return;

        var numericId = currentTaskId.replace('task-', '');
        fetch('/tasks/' + numericId + '/quick-update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                start_date: document.getElementById('popup-start').value,
                end_date: document.getElementById('popup-end').value,
                status: document.getElementById('popup-status').value,
            })
        })
        .then(r => r.json())
        .then(function() {
            hidePopup();
            location.reload();
        });
    });

    fetch('{{ url_for("projects.gantt_data", id=project.id) }}')
        .then(r => r.json())
        .then(tasks => {
            if (tasks.length === 0) return;

            // Build a lookup from task id to its data
            var taskMap = {};
            tasks.forEach(function(t) { taskMap[t.id] = t; });

            var gantt = new Gantt("#gantt", tasks, {
                view_mode: 'Week',
                date_format: 'YYYY-MM-DD',
                custom_popup_html: function(task) {
                    return `<div class="p-2">
                        <strong>${task.name}</strong><br>
                        <small>${task.start} to ${task.end}</small><br>
                        <small>Progress: ${task.progress}%</small>
                    </div>`;
                },
                on_click: function(task) {
                    currentTaskId = task.id;
                    var numericId = task.id.replace('task-', '');
                    var data = taskMap[task.id];

                    document.getElementById('popup-title').textContent = task.name;
                    document.getElementById('popup-start').value = data.start;
                    document.getElementById('popup-end').value = data.end;
                    document.getElementById('popup-detail-link').href = '/tasks/' + numericId;

                    // Extract status from custom_class (e.g. "status-in_progress priority-high")
                    var statusMatch = data.custom_class.match(/status-(\w+)/);
                    if (statusMatch) {
                        document.getElementById('popup-status').value = statusMatch[1];
                    }

                    // Position the popup near the click
                    var bar = document.querySelector('.bar-wrapper[data-id="' + task.id + '"]');
                    if (bar) {
                        var rect = bar.getBoundingClientRect();
                        popup.style.top = (rect.bottom + 8) + 'px';
                        popup.style.left = Math.min(rect.left, window.innerWidth - 320) + 'px';
                    } else {
                        popup.style.top = (event.clientY + 10) + 'px';
                        popup.style.left = Math.min(event.clientX, window.innerWidth - 320) + 'px';
                    }
                    popup.style.display = 'block';
                }
            });
        });
});
</script>
{% endif %}
{% endblock %}
